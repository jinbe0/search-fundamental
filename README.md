## TL;DR
- PHPとMySQLを使った学習用のミニマルサイト
- 企業の一覧が格納されたテーブルを例に、一般的な検索機能を作成するための一番簡単なサンプル
- フロントエンドにアレルギーがあっても大丈夫
- 英語アレルギーでもたぶん大丈夫

## リポジトリをクローン
次のコマンドを実行
``` shell
git clone github.com/jinbe0/search-fundamental.git
cd search-fundamental
```

### gitが無いだって？
っ `brew install git`

(CentOSならyum, Ubuntuならapt-getでインストールしてください)

## インストール
ローカルあるいはリモートの環境に、Webサーバと、わりと新し目のPHP, MySQLがインストールされていることが前提です。PHP 7.1 と MySQL 5.7 の最新版で動作確認済。今回使用するファイル:
- **search.php** - クライアント向けのフォームとサーバ側の処理が書かれているメインのファイルだよ
- **secret.php** - データベース接続に必要なユーザー情報はここに書くよ
- **table.sql** - テーブル定義とサンプルデータが7件入っているよ

これらのファイルをサーバのドキュメントルート内に置きます。

### secret.php の編集
secret.phpを開き、中にある4つのdefine文に、ホスト名、データベース名、ユーザー名、パスワードを入力して保存します。ポートは(普通は)そのままでok

### テーブルを用意
既に今回使うテーブルがある場合は飛ばしていいです。そうでない方はシェルで次のコマンドを実行。パスワードを聞かれるので入力する。
``` shell
mysql -h <ホスト名> -u <ユーザー名> -p <データベース名> < table.sql
```

シェルアレルギーの人はPHPMyAdminなどの便利なツールで、table.sqlをインポートするだけでも大丈夫です。
以上でインストールは完了。設置したサイトにアクセスして検索画面が表示されるかどうか確認します。

## 機能
ECサイトやコミュニティサービスにおいて検索機能は標準的な機能の一つです。簡単な検索ならいいけど、いろいろな条件指定に対応していくとだんだんスパゲッディなソースが出来上がってきます。そんな初級者のために、最低限のセキュリティとエレガントな抽象化を施した検索機能のサンプルを用意しました。たった1つのPHPファイルですべての機能が使えるようになっています。ソース中のコメントを読んでください。

プログラムを書く時、同じことを2回書かないのは鉄則です。複雑な機能は、複雑になるまえに抽象化し、実装したい機能の開発に集中できるようにしましょう。今回の例では、同じような処理を関数にまとめてソースの下の方に書いています。また、検索条件をいいかんじに管理するためにクラスを作成しました。これらの抽象化のおかげで、**たった3行のソースコードを書くだけで新しい検索条件を作ることができます。もう何個条件が増えたって、あなたの頭は爆発せずに済むのです。**

## セキュリティ
ユーザーから受け取った値や、データベース中のデータを表示するには必ずエスケープが必要です。htmlspecialchars関数は基本中の基本。
また、SQLインジェクション対策のためにPDOを利用します。クエリを組み立てる時、ユーザーからの入力を直接使用してはいけません。
(今回はLIKE句のエスケープは省略しています)

## 課題
中級PHPerになるために是非考えてみて下さい。

### 1. ファイル構成
今回のサンプルではたった1つのPHPファイルにすべての処理を書いていますが、今後複雑化することを考えると適切に分割したほうがよさそうです。MVCモデルやMVVMモデルについて調べてみましょう。また、人気のフレームワークについても調べてみましょう。

### 2. データベース設計
今回のサンプルはミニマルであるため、たった1つのテーブルのみを利用していますが、実際のプロダクトでこのようなケースはまずありません。たとえば、会社の所在地が海外であることを判定できるようにしたい場合、文字列の前方一致を用いた検索の仕方では不十分です。このようなケースにおけるワークアラウンドとして、JIS都道府県コードがよく使われます。都道府県と都道府県番号からなるテーブルを用意し、会社一覧のテーブルでは都道府県番号を格納するカラムを用意します。これにより、海外かどうかの判定が容易になりますよね。もちろん、解決策はこれだけではありません。「データベースの正規化」を調べてみましょう。データベース設計が良いと、それを利用したアプリケーションの実装も直感的になりますよ。

また、CHARSETがutf8になっていますが、絵文字等を取り扱うためにもutf8mb4を利用しましょう。データベースエンジンも、MyISAMではなくInnoDBを用いるとトランザクションが使えるようになります。

### 3. データベースの利用
今回のサンプルは、スクラッチで抽象化することにより簡潔なソースコードになりました。一般的には、データベースを上手く扱うためにORMという仕組みがよく利用されます。超複雑なクエリが必要な場合を除き、ORMを利用した抽象化は直感的で、ビジネスロジックの開発により専念できるでしょう。「ORMライブラリ」について調べてみましょう。

### 4. ページネーション
お気付きかもしれませんが、今回のサンプルにはページネーション機能がありません。検索結果がすべて1ページに出力されます。ページネーションの実装にはLIMIT OFFSET句やSQL_CALC_FOUND_ROWSがよく使われますが、インデックスの効いたカラムを利用した実装が最も効率的です。MySQLにおけるページネーションのベストプラクティスを調べてみましょう。

## License
MIT

